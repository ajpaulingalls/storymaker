<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1080, height=1920" />
    <title>Story</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="/shared/base.css" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Noto+Sans+Arabic:wght@400;500;600;700;800;900&display=swap");

      :root {
        --accent-color: #fa9000;
        --accent-color-alt: #e76f51;
        --live-updates-color: #BF3640;
        --font-arabic: "Noto Sans Arabic";
        --font-body: "Montserrat";
      }

      body {
        background: #0a0a0a;
        font-family: "Montserrat", sans-serif;
      }

      body.rtl {
        font-family: var(--font-arabic), var(--font-body), sans-serif;
      }

      .loading-text {
        font-family: "Montserrat", sans-serif;
      }

      /* Background Image */
      .bg-image-container {
        direction: ltr;
      }

      /* Background Image - Horizontal Pan Effect */
      .bg-image {
        height: 100%;
        width: auto;
        opacity: 0;
        will-change: transform, opacity;
        animation: fadeInImage 1s ease-out forwards;
      }

      @keyframes fadeInImage {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }

      @keyframes panLeftToRight {
        0% { transform: translateX(0); }
        100% { transform: translateX(var(--pan-distance)); }
      }

      @keyframes panRightToLeft {
        0% { transform: translateX(var(--pan-distance)); }
        100% { transform: translateX(0); }
      }

      /* Dark overlay covering bottom half - solid semi-transparent box */
      .overlay {
        position: absolute;
        top: 1220px; /* Start around waist/middle level */
        left: 60px;
        width: 860px;
        height: 700px; /* Shorter height */
        background: rgba(20, 20, 20, 0.8); /* Dark, desaturated gray with ~80% opacity */
        border-radius: 0 90px 0 0; /* Rounded top-right corner */
        opacity: 0;
        animation: fadeInOverlay 0.5s ease-out 1s forwards;
      }

      /* For aja site (RTL), round top-left corner instead */
      body.site-aja .overlay {
        border-radius: 90px 0 0 0; /* Rounded top-left corner */
      }

      @keyframes fadeInOverlay {
        to {
          opacity: 1;
        }
      }

      /* Al Jazeera Logo - top-left */
      .logo-area {
        position: absolute;
        top: 60px;
        left: 80px;
        z-index: 20;
        opacity: 0;
        animation: fadeIn 0.6s ease-out 0.5s forwards;
      }

      .logo-image {
        width: 200px;
        height: auto;
        display: block;
      }

      body.rtl .logo-area {
        left: auto;
        right: 80px;
      }

      /* Location Indicator - top-right, aligned with logo text */
      .location-indicator {
        position: absolute;
        top: 192px; /* Aligned with logo text: 60px (logo top) + 120px (icon height) + 12px (gap) */
        right: 80px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 20;
        opacity: 0;
        animation: fadeIn 0.6s ease-out 0.8s forwards;
      }

      body.rtl .location-indicator {
        right: auto;
        left: 80px;
        flex-direction: row-reverse;
      }

      .location-text {
        font-family: "Montserrat", sans-serif;
        font-size: 28px;
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: white;
      }

      body.rtl .location-text {
        letter-spacing: 0;
        font-family: var(--font-arabic), var(--font-body), sans-serif;
      }

      .location-pin {
        width: 36px;
        height: 36px;
        fill: white;
      }

      /* Source Watermark - vertical text on left edge */
      .source-watermark {
        position: absolute;
        left: 80px;
        top: 640px; /* Approximately 1/3 down from top */
        writing-mode: vertical-rl;
        text-orientation: mixed;
        font-family: "Montserrat", sans-serif;
        font-size: 24px;
        font-weight: 400;
        color: white;
        letter-spacing: 4px;
        opacity: 0;
        animation: fadeIn 0.6s ease-out 1s forwards;
        z-index: 15;
        text-transform: uppercase;
      }

      body.rtl .source-watermark {
        left: auto;
        right: 80px;
        letter-spacing: 0;
        font-family: var(--font-arabic), var(--font-body), sans-serif;
      }

      /* Content wrapper for LIVE UPDATES and headline */
      .content-wrapper {
        position: absolute;
        top: 1180px;
        left: 100px;
        right: 100px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 20;
      }

      body.rtl .content-wrapper {
        left: auto;
        right: 80px;
      }

      /* LIVE UPDATES Tag */
      .live-updates-tag {
        opacity: 0;
        transform: translateX(-30px);
        animation: slideRight 0.5s ease-out 1.5s forwards;
      }

      body.rtl .live-updates-tag {
        transform: translateX(30px);
        direction: ltr; /* Keep text direction LTR for LIVE UPDATES tag */
        animation: slideLeft 0.5s ease-out 1.5s forwards;
      }

      @keyframes slideLeft {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .live-updates-box {
        display: inline-block;
        background: white;
        color: var(--live-updates-color);
        padding: 5px 15px;
        font-family: "Montserrat", sans-serif;
        font-size: 60px;
        font-weight: 800; /* Extra bold */
        text-transform: uppercase;
        letter-spacing: 3px;
      }

      body.rtl .live-updates-box {
        letter-spacing: 0;
        font-family: var(--font-arabic), var(--font-body), sans-serif;
      }

      /* Main Content Area */
      .content {
        padding: 0;
        z-index: 20;
      }

      body.rtl .content {
        direction: rtl;
        text-align: right;
      }

      /* Headline */
      .headline {
        font-family: "Montserrat", sans-serif;
        font-size: 76px;
        font-weight: 800; /* Extra bold */
        line-height: 1.15;
        color: white;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 30px;
        max-width: 920px;
        opacity: 0;
        transform: translateY(40px);
        animation: slideUp 0.8s ease-out 2s forwards;
      }

      body.rtl .headline {
        letter-spacing: 0;
        font-family: var(--font-arabic), var(--font-body), sans-serif;
        text-transform: none;
      }

      .headline-word {
        display: inline-block;
        margin-right: 0.15em;
        white-space: pre;
      }

      .headline .headline-word.highlight {
        color: var(--live-updates-color) !important;
      }

      /* Status badge - hidden, we use custom LIVE UPDATES tag */
      .status-badge {
        display: none !important;
      }

      /* Image credit */
      .image-credit {
        position: absolute;
        bottom: 40px;
        right: 80px;
        font-family: "Montserrat", sans-serif;
        font-size: 20px;
        color: rgba(255, 255, 255, 0.5);
        opacity: 0;
        animation: fadeIn 0.5s ease-out 3s forwards;
        z-index: 20;
      }

      body.rtl .image-credit {
        right: auto;
        left: 80px;
      }
    </style>
  </head>
  <body>
    <!-- Loading State -->
    <div class="loading-container" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading story...</div>
    </div>

    <!-- Background Image -->
    <div class="bg-image-container">
      <img class="bg-image" id="bgImage" alt="" />
    </div>

    <!-- Overlay -->
    <div class="overlay"></div>

    <!-- Al Jazeera Logo -->
    <div class="logo-area">
      <img class="logo-image" id="logoImage" src="/shared/images/ajeWhite.png" alt="Al Jazeera" />
    </div>

    <!-- Location Indicator -->
    <div class="location-indicator">
      <div class="location-text" id="location"></div>
      <svg class="location-pin" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
    </div>

    <!-- Source Watermark -->
    <div class="source-watermark" id="sourceWatermark"></div>

    <!-- Content Wrapper (LIVE UPDATES + Headline) -->
    <div class="content-wrapper">
      <!-- LIVE UPDATES Tag -->
      <div class="live-updates-tag">
        <div class="live-updates-box" id="liveUpdatesTag">LIVE UPDATES</div>
      </div>

      <!-- Main Content -->
      <div class="content">
        <h1 class="headline" id="headline"></h1>
      </div>
    </div>

    <!-- Image Credit -->
    <div class="image-credit" id="imageCredit"></div>

    <script src="/shared/story.js"></script>
    <script src="/shared/components.js"></script>
    <script>
      const SC = window.StoryComponents;

      /**
       * Parse headline and highlight key words
       * Looks for action words, important verbs, and critical terms
       */
      function parseHeadline(text) {
        const words = text.split(' ');
        // Common words to highlight in live updates (action words, critical terms)
        const highlightedWords = [
          'SHELTER', 'SHELT', 'URGES', 'URGE', 'WARNS', 'WARN', 'ALERTS', 'ALERT',
          'BREAKING', 'CRITICAL', 'IMMEDIATE', 'EVACUATE', 'EVACUATION',
          'ATTACK', 'ATTACKED', 'BOMB', 'BOMBING', 'STRIKE', 'STRIKES',
          'DEATH', 'DEATHS', 'KILLED', 'INJURED', 'CASUALTIES'
        ];
        
        const parsedWords = words.map(word => {
          // Remove punctuation for matching
          const cleanWord = word.toUpperCase().replace(/[^\w]/g, '');
          const isHighlighted = highlightedWords.some(hw => 
            cleanWord === hw || cleanWord.startsWith(hw) || cleanWord.includes(hw)
          );
          return {
            text: word,
            highlight: isHighlighted
          };
        });
        
        // Ensure at least one word is highlighted (highlight longest word if none match)
        const hasHighlight = parsedWords.some(w => w.highlight);
        if (!hasHighlight && parsedWords.length > 0) {
          // Find the longest word (by character length, excluding punctuation)
          let longestIndex = 0;
          let longestLength = parsedWords[0].text.replace(/[^\w]/g, '').length;
          
          parsedWords.forEach((word, index) => {
            const cleanLength = word.text.replace(/[^\w]/g, '').length;
            if (cleanLength > longestLength) {
              longestLength = cleanLength;
              longestIndex = index;
            }
          });
          
          parsedWords[longestIndex].highlight = true;
        }
        
        return parsedWords;
      }

      /**
       * Render headline with highlighted words
       */
      function renderHeadline(text, container, isRTL = false) {
        if (!text || !container) return;
        
        const words = parseHeadline(text);
        container.innerHTML = '';
        
        // For RTL, reverse the word order
        const wordsToRender = isRTL ? [...words].reverse() : words;
        
        wordsToRender.forEach((word, index) => {
          const span = document.createElement('span');
          const classes = ['headline-word'];
          if (word.highlight) {
            classes.push('highlight');
          }
          span.className = classes.join(' ');
          
          // For RTL, add space before word (except first), for LTR add space after (except last)
          if (isRTL) {
            span.textContent = (index > 0 ? ' ' : '') + word.text;
          } else {
            span.textContent = word.text + (index < wordsToRender.length - 1 ? ' ' : '');
          }
          container.appendChild(span);
        });
      }

      async function renderContent(articleData) {
        SC.hideLoading();
        SC.applyAccentColors(articleData);
        
        // Add site-specific class to body
        if (articleData.site === "aje") {
          document.body.classList.add("site-aje");
        } else if (articleData.site === "aja") {
          document.body.classList.add("site-aja");
        }
        
        // Logo image is already in HTML, no JavaScript needed
        
        // Set source watermark
        const sourceWatermark = document.getElementById("sourceWatermark");
        if (sourceWatermark && articleData.source) {
          sourceWatermark.textContent = articleData.source.toUpperCase();
        }
        
        // Set location
        SC.setText("location", articleData.location || articleData.category || "");
        
        // Set LIVE UPDATES tag text based on article status
        const liveUpdatesTag = document.getElementById("liveUpdatesTag");
        if (articleData.isRTL) {
          if (articleData.isLive) {
            liveUpdatesTag.textContent = "مباشر";
          } else if (articleData.isBreaking) {
            liveUpdatesTag.textContent = "عاجل";
          } else if (articleData.isDeveloping) {
            liveUpdatesTag.textContent = "متابعة";
          } else {
            liveUpdatesTag.textContent = "تحديثات مباشرة";
          }
        } else {
          if (articleData.isLive) {
            liveUpdatesTag.textContent = "LIVE";
          } else if (articleData.isBreaking) {
            liveUpdatesTag.textContent = "BREAKING";
          } else if (articleData.isDeveloping) {
            liveUpdatesTag.textContent = "DEVELOPING";
          } else {
            liveUpdatesTag.textContent = "LIVE UPDATES";
          }
        }
        
        // Render headline with highlighting
        renderHeadline(articleData.title, document.getElementById("headline"), articleData.isRTL);
        
        // Set image credit
        SC.setImageCredit("imageCredit", articleData.imageCredit, articleData.isRTL);

        // Set background image and setup pan animation
        if (articleData.imageUrl) {
          const bgImage = document.getElementById("bgImage");
          bgImage.src = articleData.imageUrl;
          
          await new Promise((resolve) => {
            bgImage.onload = () => {
              const viewportWidth = 1080;
              const panDistance = -(bgImage.offsetWidth - viewportWidth);
              bgImage.style.setProperty("--pan-distance", `${panDistance}px`);
              // For RTL (Arabic), pan from right to left - start positioned at right side
              const panAnimation = articleData.isRTL ? "panRightToLeft" : "panLeftToRight";
              if (articleData.isRTL) {
                // Set initial position to show right side of image before animation starts
                bgImage.style.transform = `translateX(${panDistance}px)`;
              }
              setTimeout(() => {
                bgImage.style.animation = `fadeInImage 0.5s ease-out forwards, ${panAnimation} 10s linear forwards`;
              }, 100);
              resolve();
            };
            bgImage.onerror = resolve;
          });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        window.StoryMaker.initStory({ renderContent });
      });
    </script>
  </body>
</html>
